<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Monitoring System</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo"><i class="fas fa-bolt"></i> Power Monitor</div>
            <div class="nav-links">
                <button class="nav-btn active" onclick="showPage('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
                <button class="nav-btn" onclick="showPage('settings')"><i class="fas fa-cog"></i> Settings</button>
                <button class="nav-btn logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
                <div class="nav-user-avatar" id="userAvatar">
                    <div class="avatar-circle" id="avatarCircle"></div>
                    <div class="avatar-info">
                        <span id="currentUser" class="avatar-name"></span>
                        <span id="userRole" class="avatar-role"></span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main App Layout: Sidebar + Content -->
    <div class="app-layout">
        <!-- LEFT SIDEBAR: Tree for admin, device list for user -->
        <aside class="app-sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-sitemap"></i> Navigation</h3>
                <button class="btn btn-sm btn-primary admin-only hidden" onclick="openAddCity()" title="Add City"><i class="fas fa-plus"></i></button>
            </div>
            <div id="deviceSidebar" class="sidebar-tree">
                <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
            </div>
        </aside>

        <!-- RIGHT CONTENT -->
        <main class="app-content">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page active">
                <header class="header">
                    <div class="header-main">
                        <h1><i class="fas fa-bolt"></i> Power Monitoring System</h1>
                        <div class="device-selector">
                            <label for="deviceSelect"><i class="fas fa-microchip"></i> Device:</label>
                            <select id="deviceSelect"><option value="">-- Select --</option></select>
                        </div>
                    </div>
                    <div class="status-bar">
                        <span id="lastUpdate">Last update: Never</span>
                        <span id="connectionStatus" class="status-offline">Offline</span>
                        <span id="alarmStatus" class="status-normal">No Alarms</span>
                    </div>
                </header>

                <div id="adminBanner" class="admin-status-banner hidden">
                    <i class="fas fa-user-shield"></i>
                    <span><strong>ADMIN MODE</strong> - Full system access</span>
                </div>

                <div id="alarmBanner" class="alarm-banner hidden">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="alarmMessage">Alarm detected!</span>
                    <button id="muteAlarm" class="mute-btn"><i class="fas fa-volume-mute"></i> Mute</button>
                </div>

                <div class="dashboard">
                    <!-- Summary Cards -->
                    <div class="summary-cards">
                        <div class="card summary-card"><h3><i class="fas fa-tachometer-alt"></i> Total Power</h3><div class="value" id="totalPower">0.00 kW</div></div>
                        <div class="card summary-card"><h3><i class="fas fa-wave-square"></i> Frequency</h3><div class="value" id="frequency">0.00 Hz</div></div>
                        <div class="card summary-card"><h3><i class="fas fa-plug"></i> Power Factor</h3><div class="value" id="powerFactor">0.00</div></div>
                        <div class="card summary-card"><h3><i class="fas fa-battery-half"></i> Energy Import</h3><div class="value" id="energyImport">0.00 kWh</div></div>
                    </div>

                    <!-- Voltage Section -->
                    <div class="voltage-section">
                        <h2><i class="fas fa-bolt"></i> Voltage Measurements</h2>
                        <div class="voltage-cards">
                            <div class="card voltage-card">
                                <h3 class="voltage-title phase-voltages">Phase Voltages</h3>
                                <div class="voltage-params">
                                    <div class="param"><label>Ua (A-N):</label><span id="voltageUa">0.00 V</span><div class="led" id="led_voltageUa"></div></div>
                                    <div class="param"><label>Ub (B-N):</label><span id="voltageUb">0.00 V</span><div class="led" id="led_voltageUb"></div></div>
                                    <div class="param"><label>Uc (C-N):</label><span id="voltageUc">0.00 V</span><div class="led" id="led_voltageUc"></div></div>
                                </div>
                            </div>
                            <div class="card voltage-card">
                                <h3 class="voltage-title line-voltages">Line Voltages</h3>
                                <div class="voltage-params">
                                    <div class="param"><label>Uab (A-B):</label><span id="voltageUab">0.00 V</span><div class="led" id="led_voltageUab"></div></div>
                                    <div class="param"><label>Ubc (B-C):</label><span id="voltageUbc">0.00 V</span><div class="led" id="led_voltageUbc"></div></div>
                                    <div class="param"><label>Uca (C-A):</label><span id="voltageUca">0.00 V</span><div class="led" id="led_voltageUca"></div></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Power Analysis -->
                    <div class="power-analysis-section">
                        <h2><i class="fas fa-chart-bar"></i> Power Analysis</h2>
                        <div class="power-grid">
                            <div class="power-card">
                                <h3 class="power-title active-power">Active Power (kW)</h3>
                                <div class="power-params">
                                    <div class="param"><label>Phase A:</label><span id="activePowerA">0.000</span><div class="led" id="led_activePowerA"></div></div>
                                    <div class="param"><label>Phase B:</label><span id="activePowerB">0.000</span><div class="led" id="led_activePowerB"></div></div>
                                    <div class="param"><label>Phase C:</label><span id="activePowerC">0.000</span><div class="led" id="led_activePowerC"></div></div>
                                    <div class="param total"><label>Total:</label><span id="activePowerTotal">0.000</span><div class="led" id="led_activePowerTotal"></div></div>
                                </div>
                            </div>
                            <div class="power-card">
                                <h3 class="power-title reactive-power">Reactive Power (kVAR)</h3>
                                <div class="power-params">
                                    <div class="param"><label>Phase A:</label><span id="reactivePowerA">0.000</span><div class="led" id="led_reactivePowerA"></div></div>
                                    <div class="param"><label>Phase B:</label><span id="reactivePowerB">0.000</span><div class="led" id="led_reactivePowerB"></div></div>
                                    <div class="param"><label>Phase C:</label><span id="reactivePowerC">0.000</span><div class="led" id="led_reactivePowerC"></div></div>
                                    <div class="param total"><label>Total:</label><span id="reactivePowerTotal">0.000</span><div class="led" id="led_reactivePowerTotal"></div></div>
                                </div>
                            </div>
                            <div class="power-card">
                                <h3 class="power-title apparent-power">Apparent Power (kVA)</h3>
                                <div class="power-params">
                                    <div class="param"><label>Phase A:</label><span id="apparentPowerA">0.000</span><div class="led" id="led_apparentPowerA"></div></div>
                                    <div class="param"><label>Phase B:</label><span id="apparentPowerB">0.000</span><div class="led" id="led_apparentPowerB"></div></div>
                                    <div class="param"><label>Phase C:</label><span id="apparentPowerC">0.000</span><div class="led" id="led_apparentPowerC"></div></div>
                                    <div class="param total"><label>Total:</label><span id="apparentPowerTotal">0.000</span><div class="led" id="led_apparentPowerTotal"></div></div>
                                </div>
                            </div>
                            <div class="power-card">
                                <h3 class="power-title power-factor">Power Factor</h3>
                                <div class="power-params">
                                    <div class="param"><label>Phase A:</label><span id="powerFactorA">0.000</span><div class="led" id="led_powerFactorA"></div></div>
                                    <div class="param"><label>Phase B:</label><span id="powerFactorB">0.000</span><div class="led" id="led_powerFactorB"></div></div>
                                    <div class="param"><label>Phase C:</label><span id="powerFactorC">0.000</span><div class="led" id="led_powerFactorC"></div></div>
                                    <div class="param total"><label>Total:</label><span id="powerFactorTotal">0.000</span><div class="led" id="led_powerFactorTotal"></div></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Three Phase -->
                    <div class="phase-section">
                        <h2><i class="fas fa-sliders-h"></i> Three Phase Parameters</h2>
                        <div class="phase-cards">
                            <div class="card phase-card">
                                <h3 class="phase-title phase-a">Phase A</h3>
                                <div class="phase-params">
                                    <div class="param"><label>Voltage:</label><span id="voltageA">0.00 V</span></div>
                                    <div class="param"><label>Current:</label><span id="currentA">0.00 A</span></div>
                                    <div class="param"><label>Active Power:</label><span id="powerA">0.00 kW</span></div>
                                    <div class="param"><label>Power Factor:</label><span id="pfA">0.000</span></div>
                                </div>
                            </div>
                            <div class="card phase-card">
                                <h3 class="phase-title phase-b">Phase B</h3>
                                <div class="phase-params">
                                    <div class="param"><label>Voltage:</label><span id="voltageB">0.00 V</span></div>
                                    <div class="param"><label>Current:</label><span id="currentB">0.00 A</span></div>
                                    <div class="param"><label>Active Power:</label><span id="powerB">0.00 kW</span></div>
                                    <div class="param"><label>Power Factor:</label><span id="pfB">0.000</span></div>
                                </div>
                            </div>
                            <div class="card phase-card">
                                <h3 class="phase-title phase-c">Phase C</h3>
                                <div class="phase-params">
                                    <div class="param"><label>Voltage:</label><span id="voltageC">0.00 V</span></div>
                                    <div class="param"><label>Current:</label><span id="currentC">0.00 A</span></div>
                                    <div class="param"><label>Active Power:</label><span id="powerC">0.00 kW</span></div>
                                    <div class="param"><label>Power Factor:</label><span id="pfC">0.000</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- THD -->
                    <div class="thd-section">
                        <h2><i class="fas fa-wave-square"></i> Total Harmonic Distortion (THD)</h2>
                        <div class="thd-grid">
                            <div class="thd-card">
                                <h3 class="thd-title voltage-thd">Voltage THD (%)</h3>
                                <div class="thd-params">
                                    <div class="param"><label>THD Ua:</label><span id="thdUa">0.00 %</span></div>
                                    <div class="param"><label>THD Ub:</label><span id="thdUb">0.00 %</span></div>
                                    <div class="param"><label>THD Uc:</label><span id="thdUc">0.00 %</span></div>
                                </div>
                            </div>
                            <div class="thd-card">
                                <h3 class="thd-title current-thd">Current THD (%)</h3>
                                <div class="thd-params">
                                    <div class="param"><label>THD Ia:</label><span id="thdIa">0.00 %</span></div>
                                    <div class="param"><label>THD Ib:</label><span id="thdIb">0.00 %</span></div>
                                    <div class="param"><label>THD Ic:</label><span id="thdIc">0.00 %</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="charts-section">
                        <h2><i class="fas fa-chart-line"></i> Real-time Charts</h2>
                        <div class="charts-grid">
                            <div class="chart-container">
                                <div class="chart-header"><h3>Voltage Trends</h3><div class="chart-legend"><span class="legend-item"><i class="fas fa-circle" style="color:#e74c3c"></i> Ua</span><span class="legend-item"><i class="fas fa-circle" style="color:#3498db"></i> Ub</span><span class="legend-item"><i class="fas fa-circle" style="color:#2ecc71"></i> Uc</span></div></div>
                                <canvas id="voltageChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <div class="chart-header"><h3>Current Trends</h3><div class="chart-legend"><span class="legend-item"><i class="fas fa-circle" style="color:#e74c3c"></i> Ia</span><span class="legend-item"><i class="fas fa-circle" style="color:#3498db"></i> Ib</span><span class="legend-item"><i class="fas fa-circle" style="color:#2ecc71"></i> Ic</span><span class="legend-item"><i class="fas fa-circle" style="color:#f39c12"></i> In</span></div></div>
                                <canvas id="currentChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <div class="chart-header"><h3>Active Power Trends</h3><div class="chart-legend"><span class="legend-item"><i class="fas fa-circle" style="color:#e74c3c"></i> Pa</span><span class="legend-item"><i class="fas fa-circle" style="color:#3498db"></i> Pb</span><span class="legend-item"><i class="fas fa-circle" style="color:#2ecc71"></i> Pc</span><span class="legend-item"><i class="fas fa-circle" style="color:#9b59b6"></i> Total</span></div></div>
                                <canvas id="powerChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="settings" class="page">
                <header class="header">
                    <h1><i class="fas fa-cog"></i> Alarm Settings</h1>
                    <div class="status-bar"><span>Set minimum and maximum values for alarms</span></div>
                </header>
                <div class="settings-container">
                    <div class="settings-section">
                        <h2><i class="fas fa-bolt"></i> Voltage Limits</h2>
                        <div class="limits-grid">
                            <div class="limit-group">
                                <h3>Phase Voltages (V)</h3>
                                <div class="limit-row"><label>Ua Min:</label><input type="number" id="min_voltageUa" step="0.1" placeholder="200"><label>Ua Max:</label><input type="number" id="max_voltageUa" step="0.1" placeholder="250"></div>
                                <div class="limit-row"><label>Ub Min:</label><input type="number" id="min_voltageUb" step="0.1" placeholder="200"><label>Ub Max:</label><input type="number" id="max_voltageUb" step="0.1" placeholder="250"></div>
                                <div class="limit-row"><label>Uc Min:</label><input type="number" id="min_voltageUc" step="0.1" placeholder="200"><label>Uc Max:</label><input type="number" id="max_voltageUc" step="0.1" placeholder="250"></div>
                            </div>
                            <div class="limit-group">
                                <h3>Line Voltages (V)</h3>
                                <div class="limit-row"><label>Uab Min:</label><input type="number" id="min_voltageUab" step="0.1" placeholder="350"><label>Uab Max:</label><input type="number" id="max_voltageUab" step="0.1" placeholder="450"></div>
                                <div class="limit-row"><label>Ubc Min:</label><input type="number" id="min_voltageUbc" step="0.1" placeholder="350"><label>Ubc Max:</label><input type="number" id="max_voltageUbc" step="0.1" placeholder="450"></div>
                                <div class="limit-row"><label>Uca Min:</label><input type="number" id="min_voltageUca" step="0.1" placeholder="350"><label>Uca Max:</label><input type="number" id="max_voltageUca" step="0.1" placeholder="450"></div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h2><i class="fas fa-tachometer-alt"></i> Current Limits (A)</h2>
                        <div class="limits-grid">
                            <div class="limit-group">
                                <div class="limit-single-row"><label>Ia Max:</label><input type="number" id="max_currentIa" step="0.1" placeholder="100"></div>
                                <div class="limit-single-row"><label>Ib Max:</label><input type="number" id="max_currentIb" step="0.1" placeholder="100"></div>
                                <div class="limit-single-row"><label>Ic Max:</label><input type="number" id="max_currentIc" step="0.1" placeholder="100"></div>
                                <div class="limit-single-row"><label>In Max:</label><input type="number" id="max_currentIn" step="0.1" placeholder="50"></div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h2><i class="fas fa-chart-bar"></i> Power Limits</h2>
                        <div class="limits-grid">
                            <div class="limit-group">
                                <h3>Active Power (kW)</h3>
                                <div class="limit-single-row"><label>Pa Max:</label><input type="number" id="max_activePowerA" step="0.1" placeholder="50"></div>
                                <div class="limit-single-row"><label>Pb Max:</label><input type="number" id="max_activePowerB" step="0.1" placeholder="50"></div>
                                <div class="limit-single-row"><label>Pc Max:</label><input type="number" id="max_activePowerC" step="0.1" placeholder="50"></div>
                                <div class="limit-single-row"><label>Total Max:</label><input type="number" id="max_activePowerTotal" step="0.1" placeholder="150"></div>
                            </div>
                            <div class="limit-group">
                                <h3>Power Factor</h3>
                                <div class="limit-single-row"><label>PFa Min:</label><input type="number" id="min_powerFactorA" step="0.01" placeholder="0.8" min="0" max="1"></div>
                                <div class="limit-single-row"><label>PFb Min:</label><input type="number" id="min_powerFactorB" step="0.01" placeholder="0.8" min="0" max="1"></div>
                                <div class="limit-single-row"><label>PFc Min:</label><input type="number" id="min_powerFactorC" step="0.01" placeholder="0.8" min="0" max="1"></div>
                                <div class="limit-single-row"><label>Total Min:</label><input type="number" id="min_powerFactorTotal" step="0.01" placeholder="0.8" min="0" max="1"></div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-actions">
                        <button class="btn btn-primary" onclick="saveSettings()"><i class="fas fa-save"></i> Save Settings</button>
                        <button class="btn btn-secondary" onclick="resetSettings()"><i class="fas fa-undo"></i> Reset to Defaults</button>
                        <button class="btn btn-success" onclick="showPage('dashboard')"><i class="fas fa-arrow-left"></i> Back to Dashboard</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ===== MODALS ===== -->

    <!-- City Modal -->
    <div id="cityModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header"><h3 id="modalCityTitle"><i class="fas fa-city"></i> Add City</h3><button class="modal-close" onclick="closeModal('cityModal')">&times;</button></div>
            <div class="modal-body">
                <input type="hidden" id="modalCityId">
                <div class="form-group"><label>City Name</label><input type="text" id="modalCityName" placeholder="e.g. Yerevan"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('cityModal')">Cancel</button><button class="btn btn-primary" onclick="saveCity()"><i class="fas fa-save"></i> Save</button></div>
        </div>
    </div>

    <!-- Branch Modal -->
    <div id="branchModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header"><h3 id="modalBranchTitle"><i class="fas fa-building"></i> Add Branch</h3><button class="modal-close" onclick="closeModal('branchModal')">&times;</button></div>
            <div class="modal-body">
                <input type="hidden" id="modalBranchId">
                <input type="hidden" id="modalBranchCityId">
                <div class="form-group"><label>Branch Name</label><input type="text" id="modalBranchName" placeholder="e.g. Main Office"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('branchModal')">Cancel</button><button class="btn btn-primary" onclick="saveBranch()"><i class="fas fa-save"></i> Save</button></div>
        </div>
    </div>

    <!-- Client Modal -->
    <div id="clientModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header"><h3 id="modalClientTitle"><i class="fas fa-user"></i> Add Client</h3><button class="modal-close" onclick="closeModal('clientModal')">&times;</button></div>
            <div class="modal-body">
                <input type="hidden" id="modalClientId">
                <input type="hidden" id="modalClientBranchId">
                <div class="form-group"><label>Client Name</label><input type="text" id="modalClientName" placeholder="e.g. John Doe"></div>
                <div id="clientCredentials">
                    <div class="form-group"><label>Login Username (email)</label><input type="email" id="modalClientUsername" placeholder="client@example.com"></div>
                    <div class="form-group"><label>Login Password</label><input type="password" id="modalClientPassword" placeholder="Min 6 characters"></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('clientModal')">Cancel</button><button class="btn btn-primary" onclick="saveClient()"><i class="fas fa-save"></i> Save</button></div>
        </div>
    </div>

    <!-- Device Modal -->
    <div id="deviceModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header"><h3 id="modalDeviceTitle"><i class="fas fa-microchip"></i> Add Device</h3><button class="modal-close" onclick="closeModal('deviceModal')">&times;</button></div>
            <div class="modal-body">
                <input type="hidden" id="modalDeviceId">
                <input type="hidden" id="modalDeviceClientId">
                <div class="form-group" id="deviceIdGroup"><label>Device ID (must exist in system)</label><select id="modalDeviceDeviceId"><option value="">-- Select --</option></select></div>
                <div class="form-group"><label>Display Name</label><input type="text" id="modalDeviceName" placeholder="e.g. Main Meter"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('deviceModal')">Cancel</button><button class="btn btn-primary" onclick="saveDevice()"><i class="fas fa-save"></i> Save</button></div>
        </div>
    </div>

    <audio id="alarmSound" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/250/250-preview.mp3" type="audio/mpeg"></audio>
    <script src="script.js"></script>
</body>
</html>
